services:
  # ============================================
  # DATABASE: PostgreSQL with pgvector
  # ============================================
  postgres:
    image: pgvector/pgvector:pg15
    container_name: smd-postgres
    environment:
      #  FIX CỨNG: Để khớp với application.properties
      POSTGRES_DB: smd_database
      POSTGRES_USER: smd_user
      POSTGRES_PASSWORD: smd_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./infrastructure/postgresql/init-db.sh:/docker-entrypoint-initdb.d/01-init-db.sh
      - ./database/core-service:/docker-entrypoint-initdb.d/migrations/core-service
      - ./database/ai-service:/docker-entrypoint-initdb.d/migrations/ai-service
    networks:
      - smd-network
    healthcheck:
      #  FIX CỨNG: User healthcheck
      test: ["CMD-SHELL", "pg_isready -U smd_user"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # CACHE: Redis
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: smd-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    networks:
      - smd-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # MESSAGE QUEUE: RabbitMQ
  # ============================================
  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: smd-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-guest}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-guest}
    ports:
      - "${RABBITMQ_PORT:-5672}:5672"
      - "${RABBITMQ_MANAGEMENT_PORT:-15672}:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
      - ./infrastructure/rabbitmq/definitions.json:/etc/rabbitmq/definitions.json:ro
    networks:
      - smd-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # BACKEND: API Gateway (Spring Cloud Gateway)
  # ============================================
  gateway:
    build:
      context: ./backend/gateway
      dockerfile: ../../infrastructure/docker/gateway/Dockerfile
    container_name: smd-gateway
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SERVER_PORT=8888 #  Ép chạy port 8888
      - CORE_SERVICE_URL=http://core-service:8081
      - AI_SERVICE_URL=http://ai-service:8082
    ports:
      - "8888:8888" #  Map ra ngoài port 8888 cho Frontend gọi
    depends_on:
      core-service:
        condition: service_healthy
    networks:
      - smd-network
    restart: unless-stopped

  # ============================================
  # BACKEND: Core Service (Java Spring Boot)
  # ============================================
  core-service:
    build:
      context: ./backend/core-service
      dockerfile: ../../infrastructure/docker/core-service/Dockerfile
    container_name: smd-core-service
    environment:
      - SPRING_PROFILES_ACTIVE=${ENVIRONMENT:-development}
      #  FIX CỨNG: Cập nhật connection string để khớp với Postgres
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/smd_database
      - SPRING_DATASOURCE_USERNAME=smd_user
      - SPRING_DATASOURCE_PASSWORD=smd_password
      - SPRING_REDIS_HOST=redis
      - SPRING_REDIS_PORT=6379
      - SPRING_RABBITMQ_HOST=rabbitmq
      - SPRING_RABBITMQ_PORT=5672
      - SPRING_RABBITMQ_USERNAME=${RABBITMQ_USER:-guest}
      - SPRING_RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-guest}
      - JWT_SECRET=${JWT_SECRET}
      - FIREBASE_SERVICE_ACCOUNT_KEY=${FIREBASE_SERVICE_ACCOUNT_KEY}
    ports:
      - "${CORE_SERVICE_PORT:-8081}:8081"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - smd-network
    restart: unless-stopped
    volumes:
      - ./uploads:/app/uploads
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  # ============================================
  # BACKEND: AI Service (Python FastAPI)
  # ============================================
  ai-service:
    build:
      context: .
      dockerfile: infrastructure/docker/ai-service/Dockerfile
    container_name: smd-ai-service
    environment:
      - ENVIRONMENT=${ENVIRONMENT:-development}
      #  FIX CỨNG: Cập nhật connection string cho AI service luôn
      - DATABASE_URL=postgresql://smd_user:smd_password@postgres:5432/smd_database
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USER=${RABBITMQ_USER:-guest}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-guest}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL}
    ports:
      - "${AI_SERVICE_PORT:-8082}:8082"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - smd-network
    restart: unless-stopped

  # ============================================
  # FRONTEND: React Application
  # ============================================
  frontend:
    build:
      context: ./frontend
      dockerfile: ../infrastructure/docker/frontend/Dockerfile
    container_name: smd-frontend
    environment:
      - VITE_API_GATEWAY_URL=http://localhost:8888
      - VITE_FIREBASE_API_KEY=${FIREBASE_API_KEY}
      - VITE_FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID}
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    depends_on:
      - gateway
    networks:
      - smd-network
    restart: unless-stopped

# ============================================
# NETWORKS
# ============================================
networks:
  smd-network:
    driver: bridge

# ============================================
# VOLUMES
# ============================================
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  rabbitmq_data:
    driver: local
